{% extends "project_task/base.html" %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}

{% block title %}
<title>Project Backlog</title>
{% endblock %}

{% block extra_styles %}
    <style>
        .tags-container {
            max-height: 1.5em; /* This might need adjustment based on your badge height */
            overflow: hidden;
            position: relative;
        }

        .tags-container::after {
            content: "...";
            position: absolute;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, transparent, white 50%);
            padding-left: 10px;
            pointer-events: none; /* Prevent the pseudo-element from being clickable */
        }
    </style>
{% endblock %}

{% block content %}
<h1>Project Backlog</h1>

<div class="container-fluid mb-4 mt-4">
    <div class="row">
        <!-- View options -->
        <div class="col-sm-10">
            <label for="view">View:</label>
            <select id="view" onchange="changeViewType(this.value)">
                {% if current_view == 'list_view' %}
                <option value="list_view" selected>List View</option>
                <option value="card_view">Card View</option>
                {% else %}
                <option value="list_view">List View</option>
                <option value="card_view" selected>Card View</option>
                {% endif %}
            </select>

        </div>
        <!-- Create New Task Button trigger modal -->
        <div class="col-sm-2 text-right" id="create-task-listview">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createNewTask">create new task</button>
        </div>
    </div>
</div>

<!-- View templates -->
{% if current_view == 'list_view' %}
    <!-- List view -->
    {% include "project_task/pb_list_view.html" %}
{% elif current_view == 'card_view' %}
    <!-- Card View Section -->
    {% include "project_task/pb_card_view.html" %}
{% endif %}

<!-- Create New Task Modal -->
<div class="modal fade" id="createNewTask" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="taskForm" method="POST">
                {% csrf_token %}
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Create New Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <div class="d-grid gap-3 text-start">
                        {{ form.name| as_crispy_field }}
                        {{ form.type| as_crispy_field}}
                        {{ form.priority| as_crispy_field}}
                        {{ form.description| as_crispy_field}}
                        {{ form.story_point| as_crispy_field}}
                        {{ form.assignee| as_crispy_field}}
                        {{ form.tags| as_crispy_field}}
                        {{ form.status| as_crispy_field}}
                        {{ form.stage| as_crispy_field}}
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <!-- Action button -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDelete" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
    <!-- jQuery Library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Function to change the view type
        function changeViewType(viewType) {
            // Update the URL with the selected view type
            window.location.href = updateURLParameter(window.location.href, 'view', viewType);
        }

        // Function to update the URL
        function updateURLParameter(url, param, paramVal) {
            let newAdditionalURL = "";
            let tempArray = url.split("?");
            let baseURL = tempArray[0];
            let additionalURL = tempArray[1];
            let temp = "";
            if (additionalURL) {
                tempArray = additionalURL.split("&");
                for (let i = 0; i < tempArray.length; i++) {
                    if (tempArray[i].split('=')[0] !== param) {
                        newAdditionalURL += temp + tempArray[i];
                        temp = "&";
                    }
                }
            }
            let rowsTxt = temp + "" + param + "=" + paramVal;
            return baseURL + "?" + newAdditionalURL + rowsTxt;
        }

        // Select2 modules for Tags input
        $(document).ready(function () {
            // Select2 modules for Tags input
            $('#id_tags').select2({
                tags: true,
                tokenSeparators: [','],
                allowClear: true,
                placeholder: 'Select tag(s)',
                theme: 'bootstrap',
            });

            // AJax code to trigger the modal
            $('#createNewTask').on('shown.bs.modal', function () {
                // Focus on the first input of the form when the modal is shown
                $('#taskForm input:first').trigger('focus')
            });
        });

        // When a delete button is clicked
        $('.delete-btn').on('click', function(e) {
            e.preventDefault();
            let deleteUrl = $(this).attr('href');
            $('#confirmDelete').data('href', deleteUrl); // Store the URL in data attribute
            $('#deleteModal').modal('show');
        });

        $(document).ready(function() {
            // Show the creation task modal and focus on the first input
            $('#createNewTask').on('shown.bs.modal', function () {
                $('#taskForm input:first').trigger('focus');
            });

            // Using event delegation for the delete button click
            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                let deleteUrl = $(this).attr('href');
                $('#confirmDelete').data('href', deleteUrl);
                $('#deleteModal').modal('show');
            });

            $('#confirmDelete').on('click', function(e) {
                e.preventDefault();
                let deleteUrl = $(this).data('href');  // Capture the href value here

                $.ajax({
                    url: deleteUrl,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if(response.status === 'success') {
                            $('#deleteModal').modal('hide');
                            let taskElement = $('.delete-btn[href="'+ deleteUrl +'"]').closest('tr, .col-sm-3');  // Use the captured deleteUrl
                            taskElement.remove();

                            // Display success message using Bootstrap
                            var successMessage = '<div class="alert alert-success" role="alert">Task successfully deleted!</div>';
                            $('#messages-container').prepend(successMessage);
                        } else {
                            // Handle unexpected server responses
                            var errorMessage = '<div class="alert alert-danger" role="alert">An error occurred. Please try again.</div>';
                            $('#messages-container').prepend(errorMessage);
                        }
                    },
                    error: function() {
                        // Handle other errors like network issues
                        var errorMessage = '<div class="alert alert-danger" role="alert">An error occurred. Please try again.</div>';
                        $('#messages-container').prepend(errorMessage);
                    }
                });
            });

        });
    </script>
{% endblock %}