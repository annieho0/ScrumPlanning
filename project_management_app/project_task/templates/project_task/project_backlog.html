{% extends "project_task/base.html" %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}

{% block title %}
<title>Project Backlog</title>
{% endblock %}

{% block extra_styles %}
<style>
    .tags-container {
        max-height: 1.5em; /* This might need adjustment based on your badge height */
        overflow: hidden;
        position: relative;
    }

    .tags-container::after {
        content: "...";
        position: absolute;
        right: 0;
        bottom: 0;
        background: linear-gradient(to right, transparent, white 50%);
        padding-left: 10px;
        pointer-events: none; /* Prevent the pseudo-element from being clickable */
    }
</style>
{% endblock %}

{% block content %}
<h1>Project Backlog</h1>

<!-- Alert Message container -->
<div id="messages-container"></div>


<!-- View options and Create New Task button -->
{% include "project_task/pb_view_filtersort_button.html" %}

<!-- View templates -->
{% if current_view == 'list_view' %}
<!-- List view -->
{% include "project_task/pb_list_view.html" %}
{% elif current_view == 'card_view' %}
<!-- Card View Section -->
{% include "project_task/pb_card_view.html" %}
{% endif %}

<!-- Create New Task Modal -->
{% include "project_task/pb_create_new_task.html" %}

<!-- Edit Task Modal -->
{% include "project_task/pb_edit_task.html" %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                {% csrf_token %}
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDelete" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}

<!-- Custom JavaScript -->
<script>

    /**
     * Change the current view type and update the URL accordingly.
     * @param {string} viewType - The desired view type.
     */
    function updateSortAndFilter() {
        let config = {
            'view': true,
            'priority_sort': true,
            'tags_filter': true,
            // ... add more filters and sorts here in the future
        };

        let updatedURL = window.location.href;

        // Iterate over each filter and sort in the config object
        for (let key in config) {
            if (config.hasOwnProperty(key)) {
                let element = document.getElementById(key);
                if (element) {
                    // Handle multi-value fields
                    if (key === 'tags_filter' && element.multiple) {
                        let selectedValues = Array.from(element.selectedOptions).map(option => option.value);
                        updatedURL = updateURLParameter(updatedURL, key, selectedValues.join(','));
                    } else {
                        let value = element.value;
                        updatedURL = updateURLParameter(updatedURL, key, value);
                    }
                }
            }
        }

        // Update the URL
        window.location.href = updatedURL;
    }

    /**
     * Update or add a parameter to the provided URL.
     * E.g., view=list_view&sort=asc
     * @param {string} url - The original URL.
     * @param {string} param - The parameter name to update/add.
     * @param {string} paramVal - The value for the parameter.
     * @returns {string} - The updated URL.
     */
    function updateURLParameter(url, param, paramVal) {
        let newAdditionalURL = "";
        let tempArray = url.split("?");
        let baseURL = tempArray[0];
        let additionalURL = tempArray[1];
        let temp = "";

        if (additionalURL) {
            tempArray = additionalURL.split("&");
            for (let i = 0; i < tempArray.length; i++) {
                if (tempArray[i].split('=')[0] !== param) {
                    newAdditionalURL += temp + tempArray[i];
                    temp = "&";
                }
            }
        }

        let rowsTxt = temp + "" + param + "=" + paramVal;
        return baseURL + "?" + newAdditionalURL + rowsTxt;
    }

    $(document).ready(function () {

        // CreateNewTaskForm Tag field Select2 initialization
        $('#createNewTaskModal #id_tags').select2({
            tags: true,
            tokenSeparators: [','],
            allowClear: true,
            placeholder: 'Select tag(s)',
            theme: 'bootstrap',
        });

        // EditTaskForm Tag field Select2 initialization
        $('#editTaskModal #id_tags').select2({
            tags: true,
            tokenSeparators: [','],
            allowClear: true,
            placeholder: 'Select tag(s)',
            theme: 'bootstrap',
        });

        // View Tag Filter Tag field Select2 initialization
        $('#tags_filter').select2({
            tags: false,
            tokenSeparators: [','],
            allowClear: true,
            placeholder: 'Select tag(s)',
            theme: 'bootstrap',
        });

        /**
         * Handle the form submission for creating a new task.
         * On success, update the UI with the new task.
         */
        $('#createNewTaskForm').submit(function (event) {
            event.preventDefault();

            const formData = $(this).serialize();
            const createTaskUrl = $(this).attr('action');

            // AJAX request to create a new task
            $.ajax({
                url: createTaskUrl,
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function (response) {
                    // Display success alert
                    displayMessage('success', response.message);

                    // Reset the form, hide the modal, and update the UI
                    $('#createNewTaskModal').modal('hide');
                    $('#createNewTaskForm').trigger("reset");

                    // Construct and append the new task to the UI
                    addTaskToUI(response.task);
                },
                error: function (response) {
                    // Display error message
                    displayMessage('danger', response.message);
                }
            });
        });

        /**
         * Handle the form field population for editing a task.
         * On success, update the UI with the selected task details.
         */
        $('#editTaskModal').on('shown.bs.modal', function (event) {
            event.preventDefault();
            const taskId = $(event.relatedTarget).data('task-id');
            const taskUrl = `/project-backlog/edit_task/${taskId}/`

            // Now you can use taskId to fetch or display task details in the modal
            $.ajax({
                url: taskUrl,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    const edit_task = response.task_data;
                    const tags = edit_task.tags;

                    // select the tags in the select2 field
                    $('#editTaskModal #id_tags option').each(function() {
                        if(tags.includes($(this).text())) {
                            $(this).prop('selected', true);
                        }
                    });
                    // update the select2 field
                    $('#editTaskModal #id_tags').trigger('change');

                    // Assuming the modal fields have IDs corresponding to the edit_task attributes
                    $('#editTaskModal #id_name').val(edit_task.name);
                    $('#editTaskModal #id_story_point').val(edit_task.story_point);
                    $('#editTaskModal #id_priority').val(edit_task.priority);
                    $('#editTaskModal #id_description').val(edit_task.description);
                    $('#editTaskModal #id_type').val(edit_task.type);
                    $('#editTaskModal #id_status').val(edit_task.status);
                    $('#editTaskModal #id_assignee').val(edit_task.assignee);
                    $('#editTaskModal #id_created_date').val(edit_task.created_date);
                },
                error: function() {
                    // Handle any errors, e.g., display a message to the user
                }
            });
        });

        /**
         * Handle delete button clicks using event delegation.
         * Open a confirmation modal.
         */
        $(document).on('click', '.delete-btn', function (e) {
            e.preventDefault();
            const taskId = $(this).data('task-id');
            const deleteUrl = `/project-backlog/delete_task/${taskId}/`
            $('#confirmDelete').data('href', deleteUrl);
            $('#confirmDelete').data('task-id', taskId);
            $('#deleteModal').modal('show');
        });

        /**
         * Confirm deletion of a task.
         * Use AJAX to request task deletion and update the UI.
         */
        $('#confirmDelete').on('click', function (e) {
            e.preventDefault();

            // Get the deleted URL from the data-href attribute of the #confirmDelete element
            const deleteUrl = $(this).data('href');

            // Retrieve the CSRF token value from the rendered hidden input
            const csrfToken = $('[name=csrfmiddlewaretoken]').val();
            // AJAX request to delete the task and update the UI
            $.ajax({
                url: deleteUrl,
                type: 'POST',
                dataType: 'json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function (response) {
                    $('#deleteModal').modal('hide');

                    // Retrieve the task ID
                    const taskId = $('#confirmDelete').data('task-id');

                    // Remove the associated table row or card
                    $('#task-row-' + taskId).remove();
                    $('#task-card-' + taskId).remove();

                    // Handle adding or removing the empty UI message
                    addOrRemoveEmptyUI();

                    // Display a success message to the user
                    displayMessage(response.status, response.message);
                },
                error: function (response) {
                    // Display an error message to the user
                    displayMessage('danger', response.message);
                }
            });
        });

        /**
         * Display an alert message on the page.
         * @param {string} type - The type of the message (e.g., 'success', 'danger').
         * @param {string} message - The message content.
         */
        function displayMessage(type, message) {
            const alertMessage = `
                <div class="alert alert-${type} fade in alert-dismissible show" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true" style="font-size:20px">×</span>
                    </button>
                    ${message}
                </div>`;
            $('#messages-container').prepend(alertMessage);

            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 3000);
        }

        /**
         * Add the provided task to the UI.
         * @param {Object} task - The task data.
         */
        function addTaskToUI(task) {

            // Construct the HTML for the tags
            let tagsHtml = '';
            task.tags.forEach(tag => {
                tagsHtml += `<span class="badge badge-info m-1">${tag}</span>`;
            });

            // Construct HTML for list view
            const listViewHtml = `
                <tr id="task-row-{{ task.id }}">
                    <td><a href="#" data-toggle="modal" data-target="#editTask" data-task-id="{{ task.id }}">${task.name}</a></td>
                    <td>${task.story_point}</td>
                    <td>${task.priority}</td>
                    <td>${tagsHtml}</td>
                    <td><a href="/delete_task/${task.id}/" class="btn btn-danger delete-btn">Delete</a></td>
                </tr>`;
            // Append the new task to the table UI
            $('#backlogTable').append(listViewHtml);

            // Construct HTML for card view
            const cardViewHtml = `
                <div class="col-sm-3" id="task-card-{{ task.id }}">
                    <div class="card mb-3" style="height: 13rem;">
                        <div class="card-body">
                            <h4 class="card-title"><a href="#" data-toggle="modal" data-target="#editTask" data-task-id="{{ task.id }}">${task.name}</a></h4>
                            <h6 class="card-subtitle mb-2 text-muted"><strong>Story Point</strong>: ${task.story_point}</h6>
                            <h6 class="card-subtitle mb-2 text-muted"><strong>Priority</strong>: ${task.priority}</h6>
                            <div class="d-flex flex-wrap align-items-start">
                                <h6 class="card-subtitle mb-2 text-muted mr-2 tags-container">
                                    <strong>Tags</strong>: ${tagsHtml}
                                    <span class="more-tags">...</span>
                                </h6>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="/delete_task/${task.id}/" class="btn btn-danger delete-btn">Delete</a>
                        </div>
                    </div>
                </div>`;
            // Append the new task to the card view UI
            $('#cardView .row').append(cardViewHtml);

            // Remove the empty message if it exists
            addOrRemoveEmptyUI();
        }

        /**
         * Handle adding or deleting the empty UI message.
         */
        function addOrRemoveEmptyUI(){
            // Check if there are any task rows left
            const remainingTasks = $('#backlogTable tr[id^="task-row-"]');
            if (remainingTasks.length === 0) {
                // Construct HTML for empty card view
                const cardViewHtml =
                    `<div class="col-12 text-center" id="task-card-empty">
                        <p class="mt-5">No tasks available.</p>
                    </div>`;
                // Append the new task to the card view UI
                $('#cardView .row').append(cardViewHtml);

                // Construct HTML for list view
                const listViewHtml =
                    `<tr id="task-row-empty">
                        <td colspan="6" class="text-center">No tasks available.</td>
                    </tr>`;
                // Append the new task to the table UI
                $('#backlogTable').append(listViewHtml);
            } else {
                // Remove the empty message if it exists
                $('#task-row-empty').remove();
                $('#task-card-empty').remove();
            }
        }

    });
</script>
{% endblock %}

