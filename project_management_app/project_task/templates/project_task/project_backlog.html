{% extends "project_task/base.html" %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}

{% block title %}
<title>Project Backlog</title>
{% endblock %}

{% block extra_styles %}
<style>
    .tags-container {
        max-height: 1.5em; /* This might need adjustment based on your badge height */
        overflow: hidden;
        position: relative;
    }

    .tags-container::after {
        content: "...";
        position: absolute;
        right: 0;
        bottom: 0;
        background: linear-gradient(to right, transparent, white 50%);
        padding-left: 10px;
        pointer-events: none; /* Prevent the pseudo-element from being clickable */
    }
</style>
{% endblock %}

{% block content %}
<h1>Project Backlog</h1>

<!-- Alert Message container -->
<div id="messages-container"></div>


<!-- View options and Create New Task button -->
<div class="container-fluid mb-4 mt-4">
    <div class="row">
        <!-- View options -->
        <div class="col-sm-2">
            <label for="view">View:</label>
            <select id="view" onchange="updateSortAndFilter()">
                {% if current_view == 'list_view' %}
                <option value="list_view" selected>List View</option>
                <option value="card_view">Card View</option>
                {% else %}
                <option value="list_view">List View</option>
                <option value="card_view" selected>Card View</option>
                {% endif %}
            </select>
        </div>

        <!-- Priority Sort options -->
        <div class="col-sm-2">
            <label for="priority_sort">Priority:</label>
            <select id="priority_sort" onchange="updateSortAndFilter()">
                {% if priority_sort == 'priority_ascending' %}
                <option value="priority_ascending" selected>Ascending</option>
                <option value="priority_descending">Descending</option>
                {% else %}
                <option value="priority_ascending">Ascending</option>
                <option value="priority_descending" selected>Descending</option>
                {% endif %}
            </select>
        </div>

        <!-- Tags Filter options -->
        <div class="col-sm-6 d-flex justify-content-start">
            <label for="tags_filter">Tags:</label>
            <select id="tags_filter" multiple="multiple" style="width: 50%" onchange="updateSortAndFilter()">
                {% for tag in tags %}
                {% if tag.name in selected_tags %}
                <option value="{{ tag.name }}" selected>{{ tag.name }}</option>
                {% else %}
                <option value="{{ tag.name }}">{{ tag.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- Create New Task Button trigger modal -->
        <div class="col-sm-2 text-right" id="create-task-listview">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createNewTask">create new
                task
            </button>
        </div>
    </div>
</div>

<!-- View templates -->
{% if current_view == 'list_view' %}
<!-- List view -->
{% include "project_task/pb_list_view.html" %}
{% elif current_view == 'card_view' %}
<!-- Card View Section -->
{% include "project_task/pb_card_view.html" %}
{% endif %}

<!-- Create New Task Modal -->
<div class="modal fade" id="createNewTask" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="taskForm" method="POST">
                {% csrf_token %}
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Create New Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <div class="d-grid gap-3 text-start">
                        {{ form.name| as_crispy_field }}
                        {{ form.type| as_crispy_field}}
                        {{ form.priority| as_crispy_field}}
                        {{ form.description| as_crispy_field}}
                        {{ form.story_point| as_crispy_field}}
                        {{ form.tags| as_crispy_field}}
                        {{ form.status| as_crispy_field}}
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <!-- Action button -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveChanges">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDelete" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Custom JavaScript -->
<script>

    /**
     * Change the current view type and update the URL accordingly.
     * @param {string} viewType - The desired view type.
     */
    function updateSortAndFilter() {
        let config = {
            'view': true,
            'priority_sort': true,
            'tags_filter': true,
            // ... add more filters and sorts here in the future
        };

        let updatedURL = window.location.href;

        // Iterate over each filter and sort in the config object
        for (let key in config) {
            if (config.hasOwnProperty(key)) {
                let element = document.getElementById(key);
                if (element) {
                    // Handle multi-value fields
                    if (key === 'tags_filter' && element.multiple) {
                        let selectedValues = Array.from(element.selectedOptions).map(option => option.value);
                        updatedURL = updateURLParameter(updatedURL, key, selectedValues.join(','));
                    } else {
                        let value = element.value;
                        updatedURL = updateURLParameter(updatedURL, key, value);
                    }
                }
            }
        }

        // Update the URL
        window.location.href = updatedURL;
    }


    /**
     * Update or add a parameter to the provided URL.
     * E.g., view=list_view&sort=asc
     * @param {string} url - The original URL.
     * @param {string} param - The parameter name to update/add.
     * @param {string} paramVal - The value for the parameter.
     * @returns {string} - The updated URL.
     */
    function updateURLParameter(url, param, paramVal) {
        let newAdditionalURL = "";
        let tempArray = url.split("?");
        let baseURL = tempArray[0];
        let additionalURL = tempArray[1];
        let temp = "";

        if (additionalURL) {
            tempArray = additionalURL.split("&");
            for (let i = 0; i < tempArray.length; i++) {
                if (tempArray[i].split('=')[0] !== param) {
                    newAdditionalURL += temp + tempArray[i];
                    temp = "&";
                }
            }
        }

        let rowsTxt = temp + "" + param + "=" + paramVal;
        return baseURL + "?" + newAdditionalURL + rowsTxt;
    }

    $(document).ready(function () {

        // Initialize Select2 for Tags multiselect input
        $('#id_tags').select2({
            tags: true,
            tokenSeparators: [','],
            allowClear: true,
            placeholder: 'Select tag(s)',
            theme: 'bootstrap',
        });

        // Initialize Select2 for Tags filter multiselect input
        $('#tags_filter').select2({
            tags: false,
            tokenSeparators: [','],
            allowClear: true,
            placeholder: 'Select tag(s)',
            theme: 'bootstrap',
        });

        /**
         * Handle the form submission for creating a new task.
         * On success, update the UI with the new task.
         */
        $('#taskForm').submit(function (event) {
            event.preventDefault();

            const formData = $(this).serialize();
            const createTaskUrl = $(this).attr('action');

            // AJAX request to create a new task
            $.ajax({
                url: createTaskUrl,
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function (response) {
                    // Display success alert
                    displayMessage('success', response.message);

                    // Reset the form, hide the modal, and update the UI
                    $('#createNewTask').modal('hide');
                    $('#taskForm').trigger("reset");

                    // Construct and append the new task to the UI
                    addTaskToUI(response.task);
                },
                error: function (response) {
                    // Display error message
                    displayMessage('danger', response.message);
                }
            });
        });

        /**
         * Add the provided task to the UI.
         * @param {Object} task - The task data.
         */
        function addTaskToUI(task) {
            let tagsHtml = '';
            task.tags.forEach(tag => {
                tagsHtml += `<span class="badge badge-info m-1">${tag}</span>`;
            });

            // HTML for list view
            const listViewHtml = `
                <tr>
                    <td>${task.name}</td>
                    <td>${task.story_point}</td>
                    <td>${task.priority}</td>
                    <td>${tagsHtml}</td>
                    <td><a href="/delete_task/${task.id}/" class="btn btn-danger delete-btn">Delete</a></td>
                </tr>`;
            $('#backlogTable').append(listViewHtml);

            // HTML for card view
            const cardViewHtml = `
                <div class="col-sm-3">
                    <div class="card mb-3" style="height: 13rem;">
                        <div class="card-body">
                            <h4 class="card-title">${task.name}</h4>
                            <h6 class="card-subtitle mb-2 text-muted"><strong>Story Point</strong>: ${task.story_point}</h6>
                            <h6 class="card-subtitle mb-2 text-muted"><strong>Priority</strong>: ${task.priority}</h6>
                            <div class="d-flex flex-wrap align-items-start">
                                <h6 class="card-subtitle mb-2 text-muted mr-2 tags-container">
                                    <strong>Tags</strong>: ${tagsHtml}
                                    <span class="more-tags">...</span>
                                </h6>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="/delete_task/${task.id}/" class="btn btn-danger delete-btn">Delete</a>
                        </div>
                    </div>
                </div>`;
            $('#cardView .row').append(cardViewHtml);
        }

        /**
         * Handle delete button clicks using event delegation.
         * Open a confirmation modal.
         */
        $(document).on('click', '.delete-btn', function (e) {
            e.preventDefault();
            const deleteUrl = $(this).attr('href');
            $('#confirmDelete').data('href', deleteUrl);
            $('#deleteModal').modal('show');
        });

        /**
         * Confirm deletion of a task.
         * Use AJAX to request task deletion and update the UI.
         */
        $('#confirmDelete').on('click', function (e) {
            e.preventDefault();
            const deleteUrl = $(this).data('href');

            // AJAX request to delete the task and update the UI
            $.ajax({
                url: deleteUrl,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    $('#deleteModal').modal('hide');
                    const taskElement = $('.delete-btn[href="' + deleteUrl + '"]').closest('tr, .col-sm-3');
                    taskElement.remove();
                    displayMessage(response.status, response.message);
                },
                error: function (response) {
                    displayMessage('danger', response.message);
                }
            });
        });

        /**
         * Display an alert message on the page.
         * @param {string} type - The type of the message (e.g., 'success', 'danger').
         * @param {string} message - The message content.
         */
        function displayMessage(type, message) {
            const alertMessage = `
                <div class="alert alert-${type} fade in alert-dismissible show" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true" style="font-size:20px">×</span>
                    </button>
                    ${message}
                </div>`;
            $('#messages-container').prepend(alertMessage);

            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 3000);
        }
    });
</script>
{% endblock %}

