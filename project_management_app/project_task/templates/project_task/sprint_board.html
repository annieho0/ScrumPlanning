{% extends "project_task/base.html" %}

{% block title %}
<title>Sprint Board</title>
{% endblock %}

{% block content %}
<h1>Sprint Board</h1>
<button class="btn btn-info" onclick="showHelp()">Help</button>


<!-- View options -->
<label for="view">View:</label>
<select id="view" onchange="changeView()">
    <option value="listView">List View</option>
    <option value="kanbanView">Kanban View</option>
</select>

<!-- View options -->
<label for="filter">Filter Tag(s):</label>
<select id="filter" onchange="filterTasks()">
    <option value="">All</option>
    {% for tag in tags %}
    {% if tag.name in selected_tags %}
    <option value="{{ tag.name }}" selected>{{ tag.name }}</option>
    {% else %}
    <option value="{{ tag.name }}">{{ tag.name }}</option>
    {% endif %}
    {% endfor %}

</select>


<!-- List view -->
<div class="container-fluid" id="listView" style="margin-top: 20px;">
    <table class="table table-striped table-bordered">
        <thead class="thead-light">
            <tr>
                <th>Task Name</th>
                <th>Story Points</th>
                <th>Tag</th>
                <th>Assignee</th>
            </tr>

        </thead>
        {% for status_title in statuses %}
        <thead class="thead-dark">
            <tr>
                <th colspan="4">{{status_title.1}}</th>
                
            </tr>
        </thead>
        
        <tbody id="backlogTable">
            
            <!-- Rows will be dynamically added here -->
            {% for task in tasks%}  
            {% if task.status == status_title.0 %}
            <tr data-category="{% for tag in task.tags.all %}{{ tag.name }} {% endfor %}" data-task-id="{{ task.id }}">
                
                <td>
                    <a href="#" data-toggle="modal" data-target="#editTaskModal" data-task-id="{{ task.id }}" data-task-type ="{{ task.type }}">{{ task.name }}</a>
                </td>
                <td>{{task.story_point}}</td>       
                <td>{% for tag in task.tags.all %}
                    <span class="badge badge-info">{{ tag.name }}</span>
                {% endfor %}
                </td>
                <td>{{task.assignee}}</td>       
                
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
        {% endfor %}
        
    </table>
</div>


<!-- Card View Section -->
<div class="container-fluid" id="kanbanView" style="display: none;">
    <div class="row">        
        {% for status_title in statuses %}
            <!-- {{ status_title.1 }} Column -->
            <div class="col-sm-4">
                <div class="card">
                    <div class="card-header"><h2>{{ status_title.1 }}</h2></div>
                    <div class="card-body">
                        {% for task in tasks %}
                        {% if task.status == status_title.0 %}
                        {% for tag in task.tags.all %}                                        
                            <div class="card mb-3" style="width: 10rem;" id="{{ tag.name}}" >
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <a href="#" data-toggle="modal" data-target="#editTaskModal" data-task-id="{{ task.id }}">{{ task.name }}</a></h5>
                                    <h6 class="card-subtitle mb-2 text-muted"><strong>Story Point:</strong> {{task.story_point}}</h6>
                                    <h6 class="card-text mb-2 text-muted"><strong>Assignee:</strong> {{task.assignee}}</h6>
                                    <h6 class="card-text mb-2 text-muted"><strong>Tags:</strong>{% for tag in task.tags.all %}
                                            <span class="badge badge-info"> {{ tag.name }}</span>
                                        {% endfor %}
                                    </h6>
                                                                      
                                    
                                </div>
                            </div>
                        {% endfor %}
                        {% endif %}
                        {% endfor %}
                    </div>
                    
                </div>
            </div>
        {% endfor %}

    </div> <!-- End of row -->
</div> <!-- End of container -->
{% for task in tasks %}
<div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Edit Task</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <form id="editTaskForm" method="post" action="{% url 'update_task' task.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" class="form-control" id="name" name="name" value="">
                    </div>
                    <div class="form-group">
                        <label for="assignee">Assignee:</label>
                        <input type="text" class="form-control" id="assignee" name="assignee" value="">
                    </div>
                    <div class="form-group">
                        <label for="editTaskHours">Log Hours</label>
                        <input type="number" class="form-control" id="editTaskHours" min="0">
                    </div>
                    <div class="form-group">
                        <label for="editTaskTotalHours">Total Hours</label>
                        <input type="text" class="form-control" id="editTaskTotalHours" readonly>
                    </div>
                    <div class="form-group">
                        <label for="status">Status:</label>
                        <select class="form-control" id="status" name="status">
                            <option value='NOT'>Incomplete</option>
                            <option value='IN_PROG'>In Progress</option>
                            <option value='COM'>Complete</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="type">Type:</label>
                        <input type="text" class="form-control" id="type" name="type" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="priority">Priority:</label>
                        <input type="text" class="form-control" id="priority" name="priority" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="story_point">Story Point:</label>
                        <input type="text" class="form-control" id="story_point" name="story_point" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="tags">Tags:</label>
                        <input type="text" class="form-control" id="tags" name="tags" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="stage">Stage:</label>
                        <input type="text" class="form-control" id="stage" name="stage" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="created_date">Created Date:</label>
                        <input type="text" class="form-control" id="created_date" name="created_date" value="" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="updateChanges">Update changes</button>
                </div>
            </form>

        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block js %}

<script>
    
    function changeView() {
        const selectedView = document.getElementById("view").value;
        if (selectedView === "listView") {
            document.getElementById("listView").style.display = "block";
            document.getElementById("kanbanView").style.display = "none";
        } else if (selectedView === "kanbanView") {
            document.getElementById("listView").style.display = "none";
            document.getElementById("kanbanView").style.display = "block";
        }
    }
    function showHelp() {
            alert("This page displays the Sprint Board for a sprint that is currently running. List View and Kanban Views can be used to view the Sprint Board. Tasks on the Sprint Board can be filtered by the tags assigned to them. The tasks on the Sprint Board can be clicked to view additional fields and log hours for each task. ");
        }


    function filterTasks() {
        const selectedCategory = document.getElementById("filter").value;
        const rows = document.querySelectorAll("#backlogTable tr");
        const cards = document.querySelectorAll("#kanbanView .card.mb-3"); // Select all cards with class "card mb-3" in the kanbanView

        rows.forEach(row => {
            const category = row.getAttribute("data-category");
            if (selectedCategory === "" || category.includes(selectedCategory)) {
                row.style.display = "table-row";
            } else {
                row.style.display = "none";
            }
        });

        cards.forEach(card => {
            const cardTags = card.querySelectorAll(".badge-primary"); // Get tags within the card
            let cardMatchesCategory = false;

            cardTags.forEach(tag => {
                const tagCategory = tag.textContent.trim();
                if (selectedCategory === "" || tagCategory.includes(selectedCategory)) {
                    cardMatchesCategory = true;
                }
            });

            if (cardMatchesCategory) {
                card.style.display = "block"; // Show the card
            } else {
                card.style.display = "none"; // Hide the card
            }
        });
    }
    $(document).on('click', 'a[data-toggle="modal"][data-target="#editTaskModal"]', function () {
        var taskId = $(this).data('task-id');
        var taskName = $(this).text();
        var taskAssignee = $(this).closest('tr').find('td:eq(2)').text();
        var tasktype = $(this).data('task-type');
        var logHoursInput = $("#editTaskHours");
        var totalHoursInput = $("#editTaskTotalHours");
        logHoursInput.on("input", function () {
            var loggedHours = parseFloat(logHoursInput.val()) || 0;
            totalHoursInput.val(loggedHours);
        });

        $('#editTaskModal').find('form').attr('action', `/sprint-board/update_task/${taskId}/`);
        // Update the URL here

        // Update the modal form fields
        $('#editTaskModal #name').val(taskName);
        $('#editTaskModal #assignee').val(taskAssignee);
        $('#editTaskModal #status').val(taskStatus); 
        $('#edittaskmodal #type').val(tasktype); 
    });

    // Event listener for submitting the edit task form
    $('#editTaskForm').on('submit', function (e) {
        e.preventDefault();

        var taskId = $(this).attr('action').split('=')[1]; // Extract the taskId from the action URL
        var formData = $(this).serialize();

        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: formData,
            success: function (data) {
                if (data.success) {
                    $('#editTaskModal').modal('hide');
                    // You can optionally update the task details displayed on the page here
                }
            },
            error: function (error) {
                console.error("Error:", error);
            }
        });
    });


</script>
{% endblock %}